<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friend Voice Messenger - Secure Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
            height: 100vh;
            overflow: hidden; /* Prevent scrolling while locked */
        }
        
        /* The main app container */
        .app-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 1rem;
            filter: blur(5px); /* Blurred when locked */
            transition: filter 0.5s ease;
            pointer-events: none; /* Unclickable when locked */
        }
        
        /* When unlocked, remove blur and enable clicks */
        body.unlocked .app-container {
            filter: blur(0);
            pointer-events: all;
        }

        .card {
            background-color: white;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 600px;
            width: 100%;
            position: relative;
        }

        /* Login Overlay Styles */
        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(30, 41, 59, 0.95); /* Dark blue background */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50; /* Sit on top of everything */
            transition: opacity 0.5s ease, visibility 0.5s;
        }

        body.unlocked #login-overlay {
            opacity: 0;
            visibility: hidden;
        }

        .login-card {
            background: white;
            padding: 2.5rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: translateY(0);
            transition: transform 0.3s ease;
        }

        .btn-primary {
            background-color: #6366f1;
            color: white;
            transition: all 0.2s;
        }
        .btn-primary:hover { background-color: #4f46e5; }
        .btn-primary:active { transform: scale(0.98); }

        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 1.25rem;
            height: 1.25rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- LOGIN SCREEN OVERLAY -->
    <div id="login-overlay">
        <div class="login-card">
            <div class="mb-4 text-indigo-600">
                <i class="fas fa-lock text-5xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Restricted Access</h2>
            <p class="text-gray-500 mb-6 text-sm">Please enter your User ID to unlock the Voice Messenger.</p>
            
            <form id="login-form" onsubmit="handleLogin(event)">
                <input type="password" id="userid-input" 
                       class="w-full p-3 border border-gray-300 rounded-lg mb-4 text-center focus:ring-2 focus:ring-indigo-500 outline-none" 
                       placeholder="Enter User ID" autocomplete="off">
                <button type="submit" id="login-btn" class="btn-primary w-full p-3 rounded-lg font-bold shadow-lg">
                    Unlock
                </button>
                <p id="login-error" class="text-red-500 text-sm mt-3 hidden"></p>
            </form>

            <div class="mt-6 pt-4 border-t border-gray-100">
                <p class="text-xs text-gray-400">Allowed IDs for Demo: <span class="font-mono bg-gray-100 p-1 rounded">friend1</span> or <span class="font-mono bg-gray-100 p-1 rounded">guest</span></p>
                <button onclick="toggleAdminPanel()" class="text-xs text-gray-300 hover:text-gray-500 mt-2 underline">Admin: Generate New Hash</button>
            </div>
        </div>
    </div>

    <!-- MAIN APP INTERFACE -->
    <div class="app-container">
        <div class="card">
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Voice Messenger</h1>
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
                    <span class="text-xs text-green-600 font-bold uppercase tracking-wider">Online</span>
                </div>
            </div>

            <!-- Voice Select -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Friend's Voice</label>
                <select id="voice-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 bg-gray-50">
                    <option value="pNInz6obpgDQGcFmaJgB">Adam (Friend 1)</option>
                    <option value="21m00Tcm4Pl8PNDS0JdY">Rachel (Friend 2)</option>
                    <option value="AZhBw47A9jLgG94pQvW4">Tony (Friend 3)</option>
                    <option value="EXAVgK4W5gAtlj0P7vTq">Sarah (Friend 4)</option>
                </select>
            </div>

            <!-- Text Input -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Message</label>
                <textarea id="text-input" rows="4" maxlength="250" 
                          placeholder="Type your cheerful message here..."
                          class="w-full p-4 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 resize-none"></textarea>
                <p id="char-count" class="text-xs text-gray-500 text-right mt-1">0 / 250</p>
            </div>

            <!-- Action Button -->
            <button id="generate-btn" class="btn-primary w-full flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <span id="btn-text">Generate Voice</span>
                <div id="spinner" class="spinner ml-3 hidden"></div>
            </button>

            <!-- Audio Player -->
            <div id="audio-container" class="mt-6 hidden bg-gray-50 p-4 rounded-lg border border-gray-100">
                <p class="text-sm font-medium text-gray-700 mb-2">Result:</p>
                <audio id="audio-player" controls class="w-full h-10"></audio>
            </div>

            <!-- Status Messages -->
            <div id="status-message" class="mt-4 text-center text-sm hidden font-medium"></div>
        </div>
    </div>

    <!-- Hidden Admin Panel to Generate Hashes -->
    <div id="admin-panel" class="fixed bottom-0 left-0 w-full bg-gray-800 text-white p-4 transform translate-y-full transition-transform z-50">
        <div class="max-w-2xl mx-auto">
            <div class="flex justify-between items-center mb-2">
                <h3 class="font-bold">Admin Tool: Hash Generator</h3>
                <button onclick="toggleAdminPanel()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex gap-2">
                <input type="text" id="new-id-input" placeholder="Enter new User ID to hash" class="flex-1 p-2 rounded text-gray-800">
                <button onclick="generateHash()" class="bg-green-600 px-4 py-2 rounded font-bold hover:bg-green-500">Generate</button>
            </div>
            <p class="text-xs text-gray-400 mt-2">Hash Result (Copy this to users.json):</p>
            <code id="hash-output" class="block bg-black p-2 mt-1 rounded text-green-400 font-mono text-xs break-all">...</code>
        </div>
    </div>

    <script>
        // --- 1. SECURITY & LOGIN CONFIGURATION ---
        
        // ðŸš¨ YOUR API KEY GOES HERE
        // While not 100% hacker-proof in the browser, the Login Screen prevents 
        // casual users from ever reaching the code that uses this key.
        const ELEVENLABS_API_KEY = ""; 

        // ðŸ”’ FALLBACK USERS (Used if users.json can't be loaded, e.g., in preview)
        // These are SHA-256 hashes for "friend1" and "guest"
        const FALLBACK_USERS = [
            "d4735e3a265e16eee03f59718b9b5d03019c07d8b6c51f90da3a666eec13ab35", // friend1
            "84968153b677a296152cf73059da1c618d3615964724e03da80275811c754668"  // guest
        ];

        let allowedHashes = [];

        // --- 2. HASHING FUNCTION (The "Digital Smoothie" Maker) ---
        async function sha256(source) {
            const sourceBytes = new TextEncoder().encode(source);
            const digest = await crypto.subtle.digest("SHA-256", sourceBytes);
            const resultBytes = [...new Uint8Array(digest)];
            return resultBytes.map(x => x.toString(16).padStart(2, '0')).join("");
        }

        // --- 3. LOGIN LOGIC ---
        
        async function loadAllowedUsers() {
            try {
                // Try to fetch the external file
                const response = await fetch('users.json');
                if (!response.ok) throw new Error("File not found");
                allowedHashes = await response.json();
                console.log("Loaded users from users.json");
            } catch (e) {
                // If fetch fails (like in preview), use fallback
                console.warn("Could not load users.json (using fallback list):", e);
                allowedHashes = FALLBACK_USERS;
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const input = document.getElementById('userid-input');
            const btn = document.getElementById('login-btn');
            const errorMsg = document.getElementById('login-error');
            const userText = input.value.trim();

            if (!userText) return;

            // Show loading state
            btn.innerHTML = '<div class="spinner border-indigo-500 border-t-white mx-auto"></div>';
            errorMsg.classList.add('hidden');

            try {
                // Hash the input and compare
                const inputHash = await sha256(userText);
                
                // Allow if hash matches ANY in the allowed list
                if (allowedHashes.includes(inputHash)) {
                    unlockApp();
                } else {
                    throw new Error("Invalid User ID");
                }
            } catch (err) {
                // Failed login
                btn.textContent = 'Unlock';
                errorMsg.textContent = "Access Denied: ID not found.";
                errorMsg.classList.remove('hidden');
                input.classList.add('border-red-500', 'bg-red-50');
                
                // Shake animation effect
                const card = document.querySelector('.login-card');
                card.style.transform = 'translateX(10px)';
                setTimeout(() => card.style.transform = 'translateX(-10px)', 100);
                setTimeout(() => card.style.transform = 'translateX(0)', 200);
            }
        }

        function unlockApp() {
            document.body.classList.add('unlocked');
            // Clear the password field for security
            document.getElementById('userid-input').value = '';
        }

        // --- 4. APP LOGIC (ElevenLabs Interaction) ---

        const textInput = document.getElementById('text-input');
        const generateBtn = document.getElementById('generate-btn');
        const btnText = document.getElementById('btn-text');
        const spinner = document.getElementById('spinner');
        const statusMsg = document.getElementById('status-message');
        const audioPlayer = document.getElementById('audio-player');
        const audioContainer = document.getElementById('audio-container');

        // Character count
        textInput.addEventListener('input', () => {
            const len = textInput.value.length;
            document.getElementById('char-count').textContent = `${len} / 250`;
            generateBtn.disabled = len === 0 || len > 250;
        });

        generateBtn.addEventListener('click', async () => {
            const text = textInput.value;
            const voiceId = document.getElementById('voice-select').value;
            
            // UI Loading State
            generateBtn.disabled = true;
            btnText.textContent = "Generating...";
            spinner.classList.remove('hidden');
            statusMsg.classList.add('hidden');
            audioContainer.classList.add('hidden');

            try {
                if(!ELEVENLABS_API_KEY) throw new Error("API Key is missing in the code!");

                const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'xi-api-key': ELEVENLABS_API_KEY,
                    },
                    body: JSON.stringify({
                        text: text,
                        model_id: "eleven_multilingual_v2",
                        voice_settings: { stability: 0.5, similarity_boost: 0.75 }
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail?.message || "API Error");
                }

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                audioPlayer.src = url;
                audioContainer.classList.remove('hidden');
                audioPlayer.play();

            } catch (err) {
                statusMsg.textContent = "Error: " + err.message;
                statusMsg.className = "mt-4 text-center text-sm font-bold text-red-600";
                statusMsg.classList.remove('hidden');
            } finally {
                generateBtn.disabled = false;
                btnText.textContent = "Generate Voice";
                spinner.classList.add('hidden');
            }
        });

        // --- 5. ADMIN TOOL LOGIC ---
        function toggleAdminPanel() {
            const panel = document.getElementById('admin-panel');
            panel.classList.toggle('translate-y-full');
        }

        async function generateHash() {
            const input = document.getElementById('new-id-input').value;
            if(!input) return;
            const hash = await sha256(input);
            document.getElementById('hash-output').textContent = `"${hash}",`;
        }

        // Initialize
        loadAllowedUsers();

    </script>
</body>
</html>
